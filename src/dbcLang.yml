name: DBC
scopeName: source.dbc
fileTypes: [dbc]

firstLineMatch: 'VERSION ".*?"' # Match greedy

foldingStartMarker: 'BO_ .*'
foldingStopMarker: '^\s*$' # blank line

patterns:
- include: "#keywords"
- include: "#strings"
- include: "#semicolon"
- include: "#new_symbols"
- include: "#bitTiming"
- include: "#nodeNames"
- include: "#valTable"

repository:
  keywords:
    patterns:
    - name: keyword.other.dbc
      match: "^VERSION\\b" # match the version string at the start of DBC's
    - name: entity.name.header.dbc
      match: "^NS_\\b"
  strings:
    name: string.quoted.double.dbc
    begin: "\""
    end: "\""
    patterns:
    - name: constant.character.escape.dbc
      match: "\\\\."
  # semicolon:
  #   match: ".*?(;)\\s*$"
  #   captures: 
  #     1: 
  #       name: punctuation.terminator.statement.dbc
  new_symbols: 
    match: "^\\s*(BA_|\
                   NS_DESC_|\
                   CM_|\
                   BA_DEF_|\
                   VAL_|\
                   CAT_DEF_|\
                   CAT_|\
                   BA_DEF_DEF_|\
                   EV_DATA_|\
                   ENVVAR_DATA_|\
                   SGTYPE_|\
                   SGTYPE_VAL_|\
                   BA_DEF_SGTYPE_|\
                   BA_SGTYPE_|\
                   SIG_TYPE_REF_|\
                   VAL_TABLE_|\
                   SIG_GROUP_|\
                   SIG_VALTYPE_|\
                   SIGTYPE_VALTYPE_|\
                   BO_TX_BU_|\
                   BA_DEF_REL_|\
                   BA_REL_|\
                   BA_DEF_DEF_REL_|\
                   BU_SG_REL_|\
                   BU_EV_REL_|\
                   BU_BO_REL_|\
                   FILTER|\
                   SG_MUL_VAL_)$"
    captures: 
      1: 
        name: keyword.control.symbols.dbc

  ## This is probably terrible
  bitTiming:
    match: "^(BS_)\\s*(:?)\\s*(\\d*)\\s*(:?)\\s*(\\d*)\\s*(,?)\\s*(\\d*)"
    captures:
      1:
        name: keyword.control.bitTiming.dbc
      2:
        name: punctuation.qualifier.dbc
      3:
        name: constant.numeric.decimal.dbc
      4: 
        name: punctuation.qualifier.dbc
      5: 
        name: constant.numeric.decimal.dbc
      6: 
        name: punctuation.qualifier.dbc
      7: 
        name: constant.numeric.decimal.dbc
  
  nodeNames:
    match: "^(BU_)\\s*(:?)\\s*?(\\s(\\w+))*"
    captures:
      1:
        name: keyword.control.nodeNames.dbc
      2:
        name: punctuation.qualifier.dbc
      4:
        name: variable.parameter.dbc
        
  valTable:
    match: "^(VAL_TABLE_)\\s*(\\w+)(.*?)\\s*(;?)$"
    captures:
      1:
        name: keyword.control.valueTable.dbc
      2:
        name: variable.valtable.dbc
      3:
        patterns:
          - name: constant.numeric.decimal.dbc
            match: "\\d+"
          - include: "#strings"
      4: 
        name: punctuation.terminator.statement.dbc
    


